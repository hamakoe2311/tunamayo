<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MFC Logger データ分析ツール </title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 20px; background-color: #f5f5f5; color: #333; }
    .container { max-width: 1280px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { border-bottom: 2px solid #007bff; padding-bottom: 10px; color: #007bff; font-size: 1.5rem; }
    
    /* Control Panel */
    .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #e9ecef; border-radius: 5px; border-left: 5px solid #007bff; }
    .control-group { display: flex; flex-direction: column; gap: 5px; }
    .control-group.wide { grid-column: span 2; } 
    
    label { font-weight: bold; font-size: 0.85em; color: #555; }
    input[type="file"], input[type="datetime-local"], select, input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.95em; }
    
    /* Axis Settings Group */
    .axis-settings { display: flex; gap: 15px; flex-wrap: wrap; background: #fff; padding: 10px; border-radius: 4px; border: 1px solid #ddd; }
    .axis-group { display: flex; flex-direction: column; gap: 2px; }
    .axis-group span { font-size: 0.8em; color: #666; font-weight: bold; }
    .range-inputs { display: flex; align-items: center; gap: 5px; }
    .range-inputs input { width: 70px; }
    
    /* Series Config */
    .series-config { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background: #fff; }
    .series-item { padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd; display: flex; align-items: center; gap: 5px; font-size: 0.9em; }
    
    .type-volt { background: #f0f8ff; border-left: 3px solid #36A2EB; }
    .type-temp { background: #fff0f0; border-left: 3px solid #FF6384; }
    .type-hum  { background: #f0fff4; border-left: 3px solid #4BC0C0; }

    .series-item input[type="text"] { width: 90px; padding: 2px; }
    .series-item input[type="checkbox"] { cursor: pointer; }
    .series-item input[type="color"] { width: 30px; height: 30px; padding: 0; border: none; background: none; cursor: pointer; }
    
    /* Graph Area */
    .chart-container { position: relative; height: 500px; width: 100%; margin-bottom: 30px; background: #fff; }
    
    /* Buttons */
    .btn-group { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    button:active { transform: translateY(1px); box-shadow: none; }
    .btn-primary { background-color: #007bff; color: white; }
    .btn-success { background-color: #28a745; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; }
    
    /* Table */
    .table-container { overflow-x: auto; max-height: 400px; border: 1px solid #ccc; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85em; white-space: nowrap; }
    th, td { padding: 6px 10px; border: 1px solid #ddd; text-align: right; }
    th { background-color: #f1f3f5; position: sticky; top: 0; z-index: 10; text-align: center; font-weight: bold; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    
    .hint { font-size: 0.8em; color: #666; margin-top: 2px; }
  </style>
</head>
<body>

<div class="container">
  <h1>MFC Logger CSV Viewer v6 (全軸固定対応)</h1>

  <div class="controls">
    <div class="control-group">
      <label>1. 測定開始日時</label>
      <input type="datetime-local" id="startTimeInput">
    </div>
    <div class="control-group">
      <label>2. データ間引き & CSV選択</label>
      <div style="display:flex; gap:10px;">
        <input type="number" id="skipInterval" value="1" min="1" style="width:60px;" title="間引き数">
        <input type="file" id="csvFileInput" accept=".csv" style="flex-grow:1;">
      </div>
      <span class="hint">間引き: 1=全データ, 10=1/10表示</span>
    </div>
    
    <!-- Axis Settings -->
    <div class="control-group wide">
      <label>グラフ軸の範囲固定 (論文・レポート用)</label>
      <div class="axis-settings">
        <!-- 電圧設定 -->
        <div class="axis-group">
          <span>電圧軸 (左)</span>
          <div class="range-inputs">
            <select id="voltUnit" onchange="updateGraph()" style="width:60px;">
              <option value="V">V</option>
              <option value="mV">mV</option>
            </select>
            <input type="number" id="voltMin" step="0.1" placeholder="Min">
            <span>〜</span>
            <input type="number" id="voltMax" step="0.1" placeholder="Max">
          </div>
        </div>
        <!-- 温度設定 -->
        <div class="axis-group">
          <span style="color:#FF6384;">温度軸 (右1 ℃)</span>
          <div class="range-inputs">
            <input type="number" id="tempMin" step="1" placeholder="Min">
            <span>〜</span>
            <input type="number" id="tempMax" step="1" placeholder="Max">
          </div>
        </div>
        <!-- 湿度設定 -->
        <div class="axis-group">
          <span style="color:#4BC0C0;">湿度軸 (右2 %)</span>
          <div class="range-inputs">
            <input type="number" id="humMin" step="1" placeholder="Min">
            <span>〜</span>
            <input type="number" id="humMax" step="1" placeholder="Max">
          </div>
        </div>
      </div>
      <span class="hint">※空欄にすると自動調整(オートスケール)になります。</span>
    </div>

    <div class="control-group">
      <label>日時表示形式</label>
      <select id="dateFormatOption" onchange="updateGraph()">
        <option value="smart" selected>スマート</option>
        <option value="full">常に日付表示</option>
        <option value="time">時間のみ</option>
      </select>
    </div>
  </div>

  <!-- 表示・名称設定エリア -->
  <div id="seriesConfigContainer" style="display:none;">
    <label style="display:block; margin-bottom:5px;">データの選択・名称・色変更:</label>
    <div id="seriesConfig" class="series-config"></div>
    
    <div class="btn-group">
      <button onclick="updateGraph()" class="btn-primary">グラフ・表を更新</button>
      <button onclick="downloadImage()" class="btn-secondary">画像を保存</button>
      <button onclick="exportExcel()" class="btn-success">Excel保存</button>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="myChart"></canvas>
  </div>

  <h3>データ詳細 (最新500件)</h3>
  <div class="table-container">
    <table id="dataTable">
      <thead><tr id="tableHeader"></tr></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<script>
  let rawData = [];
  let chartInstance = null;
  
  // データタイプ定義
  const TYPE_VOLT = { axis: 'y',  label: '電圧', color: '#36A2EB' }; 
  const TYPE_TEMP = { axis: 'y1', label: '温度 (℃)', color: '#FF6384' }; 
  const TYPE_HUM  = { axis: 'y2', label: '湿度 (%)', color: '#4BC0C0' }; 
  const DEFAULT_VOLT_COLORS = ['#36A2EB', '#9966FF', '#FF9F40', '#FFCD56', '#C9CBCF', '#4BC0C0', '#FF6384'];

  // 初期日時設定
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  document.getElementById('startTimeInput').value = now.toISOString().slice(0, 16);

  document.getElementById('csvFileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) { parseCSV(event.target.result); };
    reader.readAsText(file);
  });

  function parseCSV(csvText) {
    const lines = csvText.split(/\r\n|\n/);
    rawData = [];
    const headers = lines[0].split(',');
    
    const configWrapper = document.getElementById('seriesConfigContainer');
    const configContainer = document.getElementById('seriesConfig');
    configContainer.innerHTML = '';
    configWrapper.style.display = 'block';

    let voltColorIdx = 0;

    headers.forEach((h, index) => {
      const cleanH = h.trim();
      if (cleanH === 'Time_sec' || cleanH === 'Mode' || cleanH === '') return;

      let type = 'volt';
      if (cleanH.includes('Temp')) type = 'temp';
      else if (cleanH.includes('Hum')) type = 'hum';

      const wrapper = document.createElement('div');
      wrapper.className = `series-item type-${type}`;
      
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.id = `chk_${index}`;
      chk.checked = true; 
      chk.dataset.colIndex = index;
      chk.dataset.originalName = cleanH;
      chk.dataset.type = type;

      let initialColor;
      if (type === 'temp') initialColor = TYPE_TEMP.color;
      else if (type === 'hum') initialColor = TYPE_HUM.color;
      else {
        initialColor = DEFAULT_VOLT_COLORS[voltColorIdx % DEFAULT_VOLT_COLORS.length];
        voltColorIdx++;
      }

      const colorInput = document.createElement('input');
      colorInput.type = 'color';
      colorInput.value = initialColor;
      colorInput.id = `color_${index}`;

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = cleanH;
      nameInput.id = `name_${index}`;

      const label = document.createElement('label');
      label.htmlFor = `chk_${index}`;
      let typeLabel = '(V)';
      if(type === 'temp') typeLabel = '(℃)';
      if(type === 'hum') typeLabel = '(%)';
      label.textContent = typeLabel;
      label.style.cursor = 'pointer';

      wrapper.appendChild(chk);
      wrapper.appendChild(colorInput);
      wrapper.appendChild(nameInput);
      wrapper.appendChild(label);
      configContainer.appendChild(wrapper);
    });

    for (let i = 1; i < lines.length; i++) {
      if (lines[i].trim() === '') continue;
      const row = lines[i].split(',').map(v => parseFloat(v));
      if (row.length === headers.length) rawData.push(row);
    }
    updateGraph();
  }

  function updateGraph() {
    if (rawData.length === 0) return;

    const startDate = new Date(document.getElementById('startTimeInput').value);
    let step = parseInt(document.getElementById('skipInterval').value);
    if (isNaN(step) || step < 1) step = 1;
    const dateFormatMode = document.getElementById('dateFormatOption').value;

    // --- 軸設定の取得 ---
    const voltUnit = document.getElementById('voltUnit').value;
    const voltMultiplier = (voltUnit === 'mV') ? 1000 : 1;
    
    // Helper to get number or null
    const getNum = (id) => {
        const val = document.getElementById(id).value;
        return val === "" ? null : parseFloat(val);
    };

    const vMin = getNum('voltMin');
    const vMax = getNum('voltMax');
    const tMin = getNum('tempMin');
    const tMax = getNum('tempMax');
    const hMin = getNum('humMin');
    const hMax = getNum('humMax');

    const datasets = [];
    const labels = [];
    const configItems = document.querySelectorAll('.series-config input[type="checkbox"]');
    const activeCols = [];
    
    configItems.forEach((chk) => {
      if (chk.checked) {
        const colIdx = parseInt(chk.dataset.colIndex);
        const nameInput = document.getElementById(`name_${colIdx}`);
        const colorInput = document.getElementById(`color_${colIdx}`);
        const type = chk.dataset.type;
        
        let yAxisID = TYPE_VOLT.axis;
        if (type === 'temp') yAxisID = TYPE_TEMP.axis;
        if (type === 'hum') yAxisID = TYPE_HUM.axis;

        activeCols.push({
          colIdx: colIdx,
          label: nameInput.value,
          yAxisID: yAxisID,
          color: colorInput.value,
          type: type 
        });
      }
    });

    activeCols.forEach(col => {
      datasets.push({
        label: col.label,
        data: [],
        borderColor: col.color,
        backgroundColor: col.color,
        yAxisID: col.yAxisID, 
        pointRadius: 0,
        borderWidth: 2,
        fill: false,
        tension: 0.1
      });
    });

    let prevDateObj = null;
    for (let i = 0; i < rawData.length; i += step) {
      const row = rawData[i];
      const timeSec = row[0]; 
      const currentDateObj = new Date(startDate.getTime() + timeSec * 1000);
      
      let labelStr = "";
      const timeStr = currentDateObj.toLocaleTimeString('ja-JP');
      const dateStr = currentDateObj.toLocaleDateString('ja-JP');

      if (dateFormatMode === 'full') labelStr = `${dateStr} ${timeStr}`;
      else if (dateFormatMode === 'time') labelStr = timeStr;
      else {
        if (prevDateObj === null || prevDateObj.getDate() !== currentDateObj.getDate()) {
          labelStr = `${dateStr} ${timeStr}`;
        } else {
          labelStr = timeStr;
        }
      }
      prevDateObj = currentDateObj;
      labels.push(labelStr);

      activeCols.forEach((col, idx) => {
        let val = row[col.colIdx];
        if (col.type === 'volt') {
          val = val * voltMultiplier;
        }
        datasets[idx].data.push(val);
      });
    }

    const ctx = document.getElementById('myChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: 'line',
      data: { labels: labels, datasets: datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        animation: false,
        scales: {
          x: {
            display: true,
            title: { display: true, text: '日時' },
            ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 20 }
          },
          // 左軸: 電圧
          y: {
            type: 'linear', display: true, position: 'left',
            title: { display: true, text: `電圧 (${voltUnit})`, color: TYPE_VOLT.color },
            ticks: { color: TYPE_VOLT.color },
            min: vMin, max: vMax
          },
          // 右軸1: 温度
          y1: {
            type: 'linear', display: true, position: 'right',
            title: { display: true, text: TYPE_TEMP.label, color: TYPE_TEMP.color },
            ticks: { color: TYPE_TEMP.color },
            grid: { drawOnChartArea: false },
            min: tMin, max: tMax
          },
          // 右軸2: 湿度
          y2: {
            type: 'linear', display: true, position: 'right',
            title: { display: true, text: TYPE_HUM.label, color: TYPE_HUM.color },
            ticks: { color: TYPE_HUM.color },
            grid: { drawOnChartArea: false },
            min: hMin, max: hMax
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              title: function(context) { return context[0].label; },
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) label += ': ';
                label += context.parsed.y;
                if(context.dataset.yAxisID === 'y') label += ` ${voltUnit}`;
                else if(context.dataset.yAxisID === 'y1') label += ' ℃';
                else if(context.dataset.yAxisID === 'y2') label += ' %';
                return label;
              }
            }
          }
        }
      }
    });

    updateTable(activeCols, startDate, step, voltMultiplier);
  }

  function updateTable(activeCols, startDate, step, voltMultiplier) {
    const thead = document.getElementById('tableHeader');
    const tbody = document.getElementById('tableBody');
    let headerHTML = '<th>日時</th><th>経過秒(s)</th>';
    activeCols.forEach(col => { headerHTML += `<th>${col.label}</th>`; });
    thead.innerHTML = headerHTML;

    let bodyHTML = '';
    let count = 0;
    for(let i = rawData.length - 1; i >= 0; i -= step) {
      if (count++ > 500) break;
      const row = rawData[i];
      const timeSec = row[0];
      const dt = new Date(startDate.getTime() + timeSec * 1000);
      bodyHTML += `<tr><td>${dt.toLocaleString()}</td><td>${timeSec}</td>`;
      activeCols.forEach(col => {
        let val = row[col.colIdx];
        if (col.type === 'volt') val = (val * voltMultiplier).toFixed(3);
        bodyHTML += `<td>${val}</td>`;
      });
      bodyHTML += `</tr>`;
    }
    tbody.innerHTML = bodyHTML;
  }

  function downloadImage() {
    if (!chartInstance) return;
    const link = document.createElement('a');
    link.download = 'graph_image.png';
    link.href = document.getElementById('myChart').toDataURL('image/png', 1.0);
    link.click();
  }

  function exportExcel() {
    if(!rawData.length) { alert("データがありません"); return; }
    const wb = XLSX.utils.book_new();
    const ws_data = [];
    const startDate = new Date(document.getElementById('startTimeInput').value);
    const configItems = document.querySelectorAll('.series-config input[type="checkbox"]');
    const voltUnit = document.getElementById('voltUnit').value;
    const voltMultiplier = (voltUnit === 'mV') ? 1000 : 1;

    const headers = ["日時", "経過秒(s)"];
    const activeCols = [];
    
    configItems.forEach(chk => {
      if(chk.checked) {
        const colIdx = parseInt(chk.dataset.colIndex);
        const name = document.getElementById(`name_${colIdx}`).value;
        const type = chk.dataset.type;
        let nameWithUnit = name;
        if(type === 'volt') nameWithUnit += ` [${voltUnit}]`;
        else if(type === 'temp') nameWithUnit += ' [℃]';
        else if(type === 'hum') nameWithUnit += ' [%]';
        headers.push(nameWithUnit);
        activeCols.push({ colIdx, type });
      }
    });
    ws_data.push(headers);

    rawData.forEach(row => {
      const timeSec = row[0];
      const dt = new Date(startDate.getTime() + timeSec * 1000);
      const line = [dt.toLocaleString(), timeSec];
      activeCols.forEach(col => {
        let val = row[col.colIdx];
        if(col.type === 'volt') val *= voltMultiplier;
        line.push(val); 
      });
      ws_data.push(line);
    });
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "LogData");
    XLSX.writeFile(wb, "measurement_data.xlsx");
  }
</script>
</body>
</html>
